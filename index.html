<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESTOQUE DO ESTÃšDIO RICK TATUADOR</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
h1{text-align:center}
.tabs{display:flex;gap:6px;margin-bottom:10px}
.tabs button{flex:1;padding:10px;border:none;border-radius:8px;background:#ddd}
.tabs button.active{background:#000;color:#fff}
.box{background:#fff;padding:10px;margin-bottom:10px;border-radius:8px}
input,select,button{width:100%;padding:8px;margin:4px 0}
.item{display:flex;justify-content:space-between}
.controls button{width:auto;margin-left:4px}
.zero{color:red;font-weight:bold}
.low{color:#d35400;font-weight:bold}
.hidden{display:none}
#updateBar{display:none;background:#000;color:#fff;text-align:center;padding:6px;border-radius:6px}
</style>
</head>

<body>

<div id="updateBar">ðŸ”„ Atualizando aplicativoâ€¦</div>

<script>
let user = prompt("Digite seu nome:") || "UsuÃ¡rio";
function now(){
  const d=new Date();
  return d.toLocaleDateString("pt-BR")+" "+d.toLocaleTimeString("pt-BR");
}
</script>

<h1>ESTOQUE DO ESTÃšDIO RICK TATUADOR</h1>

<div class="tabs">
  <button id="btnEstoque" class="active">ðŸ“¦ Estoque</button>
  <button id="btnHistorico">ðŸ“œ HistÃ³rico</button>
</div>

<!-- ESTOQUE -->
<div id="estoqueTab">
  <div class="box">
    <select id="catSelect"></select>
    <input id="newCat" placeholder="Nova categoria">
    <input id="newName" placeholder="Produto">
    <input id="newQty" type="number" placeholder="Quantidade">
    <button onclick="addProduct()">Adicionar</button>
  </div>
  <div id="stock"></div>
</div>

<!-- HISTÃ“RICO -->
<div id="historicoTab" class="hidden">

  <!-- FILTRO POR DATA -->
  <div class="box">
    <h3>ðŸ“… Filtro por data</h3>
    <input type="date" id="dateStart">
    <input type="date" id="dateEnd">
    <button onclick="renderHistory()">Aplicar filtro</button>
  </div>

  <!-- RELATÃ“RIO MENSAL -->
  <div class="box">
    <h3>ðŸ“Š RelatÃ³rio mensal</h3>
    <input type="month" id="monthPick">
    <button onclick="monthlyReport()">Gerar relatÃ³rio</button>
    <div id="report"></div>
  </div>

  <div class="box">
    <h3>âž• AdiÃ§Ãµes</h3>
    <div id="histAdd"></div>
  </div>

  <div class="box">
    <h3>âž– RemoÃ§Ãµes</h3>
    <div id="histRem"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyBPF8DpKpIHpYsdTRNCgHgiwCqUcosLX6c",
  authDomain: "estoque-rick-tatuador.firebaseapp.com",
  projectId: "estoque-rick-tatuador"
});
const db = getFirestore(app);

let data={}, history={adicoes:[],remocoes:[]};

async function load(){
  const p=await getDoc(doc(db,"estoque","principal"));
  data=p.exists()?p.data().data||{}:{};
  const h=await getDoc(doc(db,"estoque","history"));
  if(h.exists()) history=h.data();
  render();renderHistory();
}
async function save(){
  await setDoc(doc(db,"estoque","principal"),{data});
  await setDoc(doc(db,"estoque","history"),history);
}

window.addProduct=async()=>{
  let c=newCat.value||catSelect.value;
  if(!c||!newName.value)return;
  if(!data[c])data[c]={};
  data[c][newName.value]=parseInt(newQty.value)||0;
  history.adicoes.unshift(`âž• ${newName.value} (${user}) â€” ${now()}`);
  newCat.value=newName.value=newQty.value="";
  await save();render();
}
window.changeQty=async(c,p,d)=>{
  data[c][p]+=d;if(data[c][p]<0)data[c][p]=0;
  (d>0?history.adicoes:history.remocoes)
    .unshift(`${d>0?'âž•':'âž–'} ${p} (${user}) â€” ${now()}`);
  await save();render();renderHistory();
}

window.render=()=>{
  stock.innerHTML="";catSelect.innerHTML="";
  Object.keys(data).forEach(c=>{
    catSelect.innerHTML+=`<option>${c}</option>`;
    let b=document.createElement("div");b.className="box";
    b.innerHTML=`<h3>${c}</h3>`;
    Object.keys(data[c]).forEach(p=>{
      let q=data[c][p];
      let cls=q===0?"zero":q<=2?"low":"";
      b.innerHTML+=`
      <div class="item">
        <span class="${cls}">${p}: ${q}${q<=2?' âš ï¸':''}</span>
        <span class="controls">
          <button onclick="changeQty('${c}','${p}',-1)">âˆ’</button>
          <button onclick="changeQty('${c}','${p}',1)">+</button>
        </span>
      </div>`;
    });
    stock.appendChild(b);
  });
}

window.renderHistory=()=>{
  const s=dateStart.value?new Date(dateStart.value):null;
  const e=dateEnd.value?new Date(dateEnd.value+"T23:59"):null;
  const filter=x=>{
    const d=new Date(x.split("â€”")[1]);
    return (!s||d>=s)&&(!e||d<=e);
  }
  histAdd.innerHTML=history.adicoes.filter(filter).map(x=>`<div>${x}</div>`).join("");
  histRem.innerHTML=history.remocoes.filter(filter).map(x=>`<div>${x}</div>`).join("");
}

window.monthlyReport=()=>{
  const m=monthPick.value;
  if(!m)return;
  let add=0,rem=0;
  [...history.adicoes,...history.remocoes].forEach(x=>{
    if(x.includes(m.split("-")[1]+"/"+m.split("-")[0])){
      x.includes("âž•")?add++:rem++;
    }
  });
  report.innerHTML=`<b>AdiÃ§Ãµes:</b> ${add}<br><b>RemoÃ§Ãµes:</b> ${rem}`;
}

load();
</script>

<script>
btnEstoque.onclick=()=>{estoqueTab.classList.remove("hidden");historicoTab.classList.add("hidden")}
btnHistorico.onclick=()=>{historicoTab.classList.remove("hidden");estoqueTab.classList.add("hidden")}
</script>

</body>
</html>
