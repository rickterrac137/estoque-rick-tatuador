<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESTOQUE DO EST√öDIO RICK TATUADOR</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
h1{text-align:center}
.box{background:#fff;padding:10px;margin-bottom:10px;border-radius:8px}
input,select,button{width:100%;padding:8px;margin:4px 0}
button{font-size:16px}
.item{display:flex;justify-content:space-between;align-items:center;margin:4px 0}
.controls button{width:auto;margin-left:4px}
.zero{color:red;font-weight:bold}
.low{color:orange;font-weight:bold}
.footer{text-align:center;font-size:12px;color:#666;margin-top:20px}
.tabs{display:flex;margin-bottom:10px}
.tabs button{flex:1}
.hidden{display:none}
</style>
</head>

<body>

<script>
const APP_VERSION = "v1.7.0";
let user = prompt("Digite seu nome:");
</script>

<h1>ESTOQUE DO EST√öDIO</h1>

<div class="tabs">
  <button onclick="showTab('estoque')">üì¶ Estoque</button>
  <button onclick="showTab('historico')">üìú Hist√≥rico</button>
</div>

<div id="estoqueTab">

<div class="box">
<input id="search" placeholder="üîç Pesquisar produto" oninput="render()">
</div>

<div class="box">
<select id="catSelect"></select>
<input id="newCat" placeholder="Ou nova categoria">
<input id="newName" placeholder="Produto">
<input id="newQty" type="number" placeholder="Quantidade">
<button onclick="addProduct()">Adicionar</button>
</div>

<div id="stock"></div>
</div>

<div id="historicoTab" class="hidden">
<div class="box">
<h3>‚ûï Adi√ß√µes</h3>
<div id="histAdd"></div>
</div>

<div class="box">
<h3>‚ûñ Remo√ß√µes</h3>
<div id="histRem"></div>
</div>
</div>

<div id="updateBox" style="
display:none;
position:fixed;
top:0;
left:0;
right:0;
background:#000;
color:#fff;
padding:10px;
text-align:center;
z-index:9999;
font-weight:bold">
üîÑ Atualizando aplicativo‚Ä¶
</div>

<div class="footer">
<span>Vers√£o do app: <b id="ver"></b></span>
<span>app oficial do denis costa</span>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
document.getElementById("ver").innerText = APP_VERSION;

const firebaseConfig = {
  apiKey: "AIzaSyBPF8DpKpIHpYsdTRNCgHgiwCqUcosLX6c",
  authDomain: "estoque-rick-tatuador.firebaseapp.com",
  projectId: "estoque-rick-tatuador",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let data = {};
let histAdd = [];
let histRem = [];

function showTab(tab){
  estoqueTab.classList.toggle("hidden", tab!=="estoque");
  historicoTab.classList.toggle("hidden", tab!=="historico");
}

async function load(){
  const s = await db.collection("estoque").doc("principal").get();
  if(s.exists) data = s.data().data || {};
  const h = await db.collection("estoque").doc("history").get();
  if(h.exists){
    histAdd = h.data().add || [];
    histRem = h.data().rem || [];
  }
  render();
}

async function save(){
  await db.collection("estoque").doc("principal").set({data});
  await db.collection("estoque").doc("history").set({add:histAdd,rem:histRem});
}

function addProduct(){
  let cat = newCat.value || catSelect.value;
  if(!cat||!newName.value)return alert("Preencha tudo");
  if(!data[cat])data[cat]={};
  data[cat][newName.value]=parseInt(newQty.value)||0;
  histAdd.unshift(`‚ûï ${newName.value} (${user}) ${new Date().toLocaleString()}`);
  save();render();
}

function changeQty(c,p,d){
  data[c][p]+=d;
  if(data[c][p]<0)data[c][p]=0;
  (d>0?histAdd:histRem).unshift(`${d>0?"‚ûï":"‚ûñ"} ${p} (${user}) ${new Date().toLocaleString()}`);
  save();render();
}

function editCategory(c){
  let n=prompt("Novo nome:",c);
  if(n&&n!==c){data[n]=data[c];delete data[c];save();render();}
}
function deleteCategory(c){
  if(confirm("Excluir categoria?")){delete data[c];save();render();}
}
function editProduct(c,p){
  let n=prompt("Novo nome:",p);
  if(n&&n!==p){data[c][n]=data[c][p];delete data[c][p];save();render();}
}
function deleteProduct(c,p){
  if(confirm("Excluir produto?")){delete data[c][p];save();render();}
}

function render(){
  stock.innerHTML="";catSelect.innerHTML="";
  for(let c in data){
    catSelect.innerHTML+=`<option>${c}</option>`;
    let b=document.createElement("div");b.className="box";
    b.innerHTML=`<h3>${c}
    <button onclick="editCategory('${c}')">‚úèÔ∏è</button>
    <button onclick="deleteCategory('${c}')">üóëÔ∏è</button></h3>`;
    for(let p in data[c]){
      let q=data[c][p];
      b.innerHTML+=`<div class="item">
      <span class="${q==0?"zero":q<=2?"low":""}">${p}: ${q}</span>
      <span class="controls">
      <button onclick="changeQty('${c}','${p}',-1)">‚àí</button>
      <button onclick="changeQty('${c}','${p}',1)">+</button>
      <button onclick="editProduct('${c}','${p}')">‚úèÔ∏è</button>
      <button onclick="deleteProduct('${c}','${p}')">üóëÔ∏è</button>
      </span></div>`;
    }
    stock.appendChild(b);
  }
  histAddDiv.innerHTML = histAdd.slice(0,20).join("<br>");
  histRemDiv.innerHTML = histRem.slice(0,20).join("<br>");
}

load();
</script>

<script>
if("serviceWorker"in navigator){
navigator.serviceWorker.register("service-worker.js").then(reg=>{
reg.addEventListener("updatefound",()=>{
document.getElementById("updateBox").style.display="block";
});
});
}
</script>

</body>
</html>
