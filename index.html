<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estoque Rick Tatuador</title>

<link rel="manifest" href="manifest.json">

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
h1{text-align:center}
.box{background:#fff;padding:10px;margin-bottom:10px;border-radius:8px}
input,select,button{width:100%;padding:8px;margin:4px 0}
button{font-size:16px;cursor:pointer}
button:active{transform:scale(0.97)}
.item{display:flex;justify-content:space-between;align-items:center;margin:4px 0}
.controls button{width:auto;margin-left:4px}
.zero{color:red;font-weight:bold}
.low{color:orange;font-weight:bold}
.tabs{display:flex;margin-bottom:10px}
.tabs button{flex:1}
.hidden{display:none}
.highlight{background:#ffffcc}
details summary{font-weight:bold;font-size:16px;cursor:pointer}
.footer{text-align:center;font-size:12px;color:#666;margin-top:20px}
</style>
</head>

<body>

<script>
const APP_VERSION = "v2.0.0";
let user = prompt("Digite seu nome:");
</script>

<h1>ESTOQUE DO ESTÃšDIO</h1>

<div class="tabs">
  <button onclick="showTab('estoque')">ðŸ“¦ Estoque</button>
  <button onclick="showTab('historico')">ðŸ“œ HistÃ³rico</button>
</div>

<!-- ESTOQUE -->
<div id="estoqueTab">

<div class="box">
<input id="search" placeholder="ðŸ” Pesquisar produto">
<button onclick="buscarProduto()">Buscar produto</button>
</div>

<div class="box">
<select id="catSelect"></select>
<input id="newCat" placeholder="Ou nova categoria">
<input id="newName" placeholder="Produto">
<input id="newQty" type="number" placeholder="Quantidade">
<button onclick="addProduct()">Adicionar produto</button>
</div>

<div id="stock"></div>
</div>

<!-- HISTÃ“RICO -->
<div id="historicoTab" class="hidden">
  <details open class="box">
    <summary>âž• AdiÃ§Ã£o de produtos</summary>
    <div id="histAdd"></div>
  </details>

  <details class="box">
    <summary>âž– RemoÃ§Ã£o de produtos</summary>
    <div id="histRem"></div>
  </details>
</div>

<div class="footer">
<div>VersÃ£o do app: <b id="ver"></b></div>
<div>app oficial do denis costa</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
document.getElementById("ver").innerText = APP_VERSION;

firebase.initializeApp({
  apiKey: "AIzaSyBPF8DpKpIHpYsdTRNCgHgiwCqUcosLX6c",
  authDomain: "estoque-rick-tatuador.firebaseapp.com",
  projectId: "estoque-rick-tatuador"
});

const db = firebase.firestore();

let data = {};
let histAdd = [];
let histRem = [];

/* ---------- TABS ---------- */
function showTab(tab){
  estoqueTab.classList.toggle("hidden", tab !== "estoque");
  historicoTab.classList.toggle("hidden", tab !== "historico");
  if(tab === "historico") renderHistory(true);
}

/* ---------- LOAD ---------- */
async function load(){
  const e = await db.collection("estoque").doc("principal").get();
  data = e.exists ? e.data().data || {} : {};

  const a = await db.collection("estoque").doc("history_add").get();
  histAdd = a.exists ? a.data().list || [] : [];

  const r = await db.collection("estoque").doc("history_rem").get();
  histRem = r.exists ? r.data().list || [] : [];

  renderStock();
  renderHistory();
}

/* ---------- SAVE ---------- */
async function saveEstoque(){
  await db.collection("estoque").doc("principal").set({data});
}

async function saveHistory(type, msg){
  const ref = db.collection("estoque").doc(type);
  if(type === "history_add") histAdd.unshift(msg);
  if(type === "history_rem") histRem.unshift(msg);
  await ref.set({list: type==="history_add"?histAdd:histRem});
  renderHistory(true);
}

/* ---------- ACTIONS ---------- */
async function addProduct(){
  const prod = newName.value.trim();
  const qty = parseInt(newQty.value) || 0;
  const cat = newCat.value.trim() || catSelect.value;

  if(!prod || !cat) return alert("Preencha tudo");

  if(!data[cat]) data[cat] = {};
  if(data[cat][prod] !== undefined) return alert("Produto jÃ¡ existe");

  data[cat][prod] = qty;
  await saveEstoque();
  await saveHistory("history_add", `âž• ${prod} (${user}) - ${new Date().toLocaleString()}`);

  newName.value=newQty.value=newCat.value="";
  renderStock();
}

async function changeQty(c,p,d){
  data[c][p]+=d;
  if(data[c][p]<0) data[c][p]=0;

  await saveEstoque();
  await saveHistory(d>0?"history_add":"history_rem",
    `${d>0?"âž•":"âž–"} ${p} (${user}) - ${new Date().toLocaleString()}`);

  renderStock();
}

/* ---------- SEARCH ---------- */
function buscarProduto(){
  const t = search.value.toLowerCase();
  if(!t) return;
  const el = document.querySelector(`[data-prod*="${t}"]`);
  if(el){
    el.classList.add("highlight");
    el.scrollIntoView({behavior:"smooth",block:"center"});
    setTimeout(()=>el.classList.remove("highlight"),2000);
  } else alert("Produto nÃ£o encontrado");
}

/* ---------- RENDER ---------- */
function renderStock(){
  stock.innerHTML="";
  catSelect.innerHTML="";
  Object.keys(data).sort().forEach(c=>{
    catSelect.innerHTML+=`<option>${c}</option>`;
    const box=document.createElement("div");
    box.className="box";
    box.innerHTML=`<h3>${c}</h3>`;
    Object.keys(data[c]).sort().forEach(p=>{
      const q=data[c][p];
      box.innerHTML+=`
      <div class="item" data-prod="${p.toLowerCase()}">
        <span class="${q===0?'zero':q<=2?'low':''}">${p}: ${q}</span>
        <span class="controls">
          <button onclick="changeQty('${c}','${p}',-1)">âˆ’</button>
          <button onclick="changeQty('${c}','${p}',1)">+</button>
        </span>
      </div>`;
    });
    stock.appendChild(box);
  });
}

function renderHistory(force=false){
  histAdd.innerHTML = histAdd.length
    ? histAdd.map(h=>`<div>${h}</div>`).join("")
    : "<i>Nenhum registro</i>";

  histRem.innerHTML = histRem.length
    ? histRem.map(h=>`<div>${h}</div>`).join("")
    : "<i>Nenhum registro</i>";
}

load();
</script>

</body>
</html>
