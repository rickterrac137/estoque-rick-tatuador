<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESTOQUE DO ESTÃšDIO RICK TATUADOR</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
h1{text-align:center}

.tabs{
  display:flex;
  gap:6px;
  margin-bottom:10px;
}
.tabs button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:8px;
  font-size:16px;
  background:#ddd;
}
.tabs button.active{
  background:#000;
  color:#fff;
}

.box{background:#fff;padding:10px;margin-bottom:10px;border-radius:8px}
input,select,button{width:100%;padding:8px;margin:4px 0}
.item{display:flex;justify-content:space-between;align-items:center;margin:4px 0}
.controls button{width:auto;margin-left:4px}
.zero{color:red;font-weight:bold}
.footer{text-align:center;font-size:12px;color:#666;margin-top:10px}
h3 button{width:auto;margin-left:6px}

#updateBar{
  display:none;
  background:#000;
  color:#fff;
  text-align:center;
  padding:6px;
  margin-bottom:8px;
  border-radius:6px;
}
.hidden{display:none}
</style>
</head>

<body>

<div id="updateBar">ğŸ”„ Atualizando aplicativoâ€¦</div>

<script>
let user = prompt("Digite seu nome:");
if(!user) user = "UsuÃ¡rio";
const APP_VERSION = "v1.3.0";

function now(){
  const d = new Date();
  return d.toLocaleDateString("pt-BR") + " " + d.toLocaleTimeString("pt-BR");
}
</script>

<h1>ESTOQUE DO ESTÃšDIO RICK TATUADOR</h1>

<!-- ABAS -->
<div class="tabs">
  <button id="tabEstoque" class="active" onclick="showTab('estoque')">ğŸ“¦ Estoque</button>
  <button id="tabHistorico" onclick="showTab('historico')">ğŸ“œ HistÃ³rico</button>
</div>

<!-- ABA ESTOQUE -->
<div id="estoqueTab">

  <div class="box">
    <input id="search" placeholder="ğŸ” Pesquisar produto" oninput="render()">
  </div>

  <div class="box">
    <select id="catSelect"></select>
    <input id="newCat" placeholder="Ou nova categoria">
    <input id="newName" placeholder="Produto">
    <input id="newQty" type="number" placeholder="Quantidade">
    <button onclick="addProduct()">Adicionar produto</button>
  </div>

  <div id="stock"></div>

</div>

<!-- ABA HISTÃ“RICO -->
<div id="historicoTab" class="hidden">

  <div class="box">
    <h3>ğŸ“œ HistÃ³rico de AdiÃ§Ãµes</h3>
    <div id="histAdd"></div>
  </div>

  <div class="box">
    <h3>ğŸ“œ HistÃ³rico de RemoÃ§Ãµes</h3>
    <div id="histRem"></div>
  </div>

</div>

<div class="footer">
VersÃ£o do app: <b><span id="appVersion"></span></b>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPF8DpKpIHpYsdTRNCgHgiwCqUcosLX6c",
  authDomain: "estoque-rick-tatuador.firebaseapp.com",
  projectId: "estoque-rick-tatuador",
  storageBucket: "estoque-rick-tatuador.firebasestorage.app",
  messagingSenderId: "446550868475",
  appId: "1:446550868475:web:2a2ba89ccc5a076fcacb5e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data = {};
let history = { adicoes: [], remocoes: [] };

document.getElementById("appVersion").innerText = APP_VERSION;

async function load(){
  const p = await getDoc(doc(db,"estoque","principal"));
  data = p.exists() && p.data().data ? p.data().data : {};

  const h = await getDoc(doc(db,"estoque","history"));
  if(h.exists()){
    const d = h.data();
    history.adicoes = Array.isArray(d.adicoes) ? d.adicoes : [];
    history.remocoes = Array.isArray(d.remocoes) ? d.remocoes : [];
  }

  await save();
  render();
}

async function save(){
  await setDoc(doc(db,"estoque","principal"),{data});
  await setDoc(doc(db,"estoque","history"),history);
}

window.addProduct = async ()=>{
  let cat = newCat.value || catSelect.value;
  if(!cat || !newName.value) return alert("Preencha categoria e produto");
  if(!data[cat]) data[cat]={};
  data[cat][newName.value] = parseInt(newQty.value)||0;
  history.adicoes.unshift(`â• ${newName.value} (${user}) â€” ${now()}`);
  newCat.value=newName.value=newQty.value="";
  await save(); render();
}

window.changeQty = async (cat, prod, delta)=>{
  data[cat][prod] += delta;
  if(data[cat][prod] < 0) data[cat][prod] = 0;
  (delta>0?history.adicoes:history.remocoes)
    .unshift(`${delta>0?'â•':'â–'} ${prod} (${user}) â€” ${now()}`);
  await save(); render();
}

window.editCategory = async (oldCat)=>{
  let n = prompt("Novo nome da categoria:", oldCat);
  if(n && n!==oldCat){
    data[n] = data[oldCat];
    delete data[oldCat];
    await save(); render();
  }
}

window.deleteCategory = async (cat)=>{
  if(confirm("Excluir categoria e todos os produtos?")){
    delete data[cat];
    await save(); render();
  }
}

window.editProduct = async (cat, prod)=>{
  let n = prompt("Novo nome do produto:", prod);
  if(n && n!==prod){
    data[cat][n] = data[cat][prod];
    delete data[cat][prod];
    await save(); render();
  }
}

window.deleteProduct = async (cat, prod)=>{
  if(confirm("Excluir produto?")){
    delete data[cat][prod];
    await save(); render();
  }
}

window.render = ()=>{
  stock.innerHTML="";
  catSelect.innerHTML="";

  Object.keys(data).forEach(cat=>{
    catSelect.innerHTML+=`<option>${cat}</option>`;
    let box=document.createElement("div");
    box.className="box";
    box.innerHTML=`
      <h3>${cat}
        <button onclick="editCategory('${cat}')">âœï¸</button>
        <button onclick="deleteCategory('${cat}')">ğŸ—‘ï¸</button>
      </h3>`;
    Object.keys(data[cat]).forEach(prod=>{
      let qty=data[cat][prod];
      box.innerHTML+=`
        <div class="item">
          <span class="${qty===0?'zero':''}">${prod}: ${qty}</span>
          <span class="controls">
            <button onclick="changeQty('${cat}','${prod}',-1)">âˆ’</button>
            <button onclick="changeQty('${cat}','${prod}',1)">+</button>
            <button onclick="editProduct('${cat}','${prod}')">âœï¸</button>
            <button onclick="deleteProduct('${cat}','${prod}')">ğŸ—‘ï¸</button>
          </span>
        </div>`;
    });
    stock.appendChild(box);
  });

  histAdd.innerHTML = history.adicoes.slice(0,30).map(x=>`<div>${x}</div>`).join("");
  histRem.innerHTML = history.remocoes.slice(0,30).map(x=>`<div>${x}</div>`).join("");
}

load();
</script>

<script>
function showTab(tab){
  estoqueTab.classList.add("hidden");
  historicoTab.classList.add("hidden");
  tabEstoque.classList.remove("active");
  tabHistorico.classList.remove("active");

  if(tab==="estoque"){
    estoqueTab.classList.remove("hidden");
    tabEstoque.classList.add("active");
  }else{
    historicoTab.classList.remove("hidden");
    tabHistorico.classList.add("active");
  }
}

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js").then(reg=>{
    reg.onupdatefound = ()=>{
      const nw = reg.installing;
      nw.onstatechange = ()=>{
        if(nw.state==="installed" && navigator.serviceWorker.controller){
          updateBar.style.display="block";
          setTimeout(()=>location.reload(),1500);
        }
      };
    };
  });
}
</script>

</body>
</html>
