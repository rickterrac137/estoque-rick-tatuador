<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESTOQUE DO EST√öDIO RICK TATUADOR</title>

<!-- Manifest para PWA -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:0}
h1{text-align:center;margin:10px 0}
#menu{display:flex;justify-content:space-around;background:#222;color:#fff;padding:10px;border-radius:0 0 10px 10px;}
#menu button{background:#444;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:bold;}
.page{padding:10px;display:none;}
.page.active{display:block;}
.box{background:#fff;padding:10px;margin-bottom:10px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
input,select,button{width:100%;padding:8px;margin:4px 0;border-radius:6px;border:1px solid #ccc;}
button{font-size:16px;cursor:pointer;background:#333;color:#fff;}
.card{background:#fff;padding:10px;margin:6px 0;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.item{display:flex;justify-content:space-between;align-items:center;margin:4px 0}
.controls button{margin-left:4px;padding:4px 8px;border-radius:6px;}
.zero{color:red;font-weight:bold}
</style>
</head>
<body>

<script>
let user = prompt("Digite seu nome:");
</script>

<h1>ESTOQUE DO EST√öDIO RICK TATUADOR</h1>

<div id="menu">
  <button onclick="showPage('estoque')">Estoque</button>
  <button onclick="showPage('historico')">Hist√≥rico</button>
  <button onclick="showPage('categorias')">Categorias</button>
</div>

<div id="estoquePage" class="page active">
  <div class="box">
    <input id="search" placeholder="üîç Pesquisar produto" oninput="render()">
  </div>
  <div id="stock"></div>
</div>

<div id="historicoPage" class="page">
  <div class="box">
    <h3>üìú Hist√≥rico</h3>
    <div id="historyDiv"></div>
  </div>
</div>

<div id="categoriasPage" class="page">
  <div class="box">
    <select id="catSelect"></select>
    <input id="newCat" placeholder="Ou nova categoria">
    <input id="newName" placeholder="Produto">
    <input id="newQty" type="number" placeholder="Quantidade">
    <button onclick="addProduct()">Adicionar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPF8DpKpIHpYsdTRNCgHgiwCqUcosLX6c",
  authDomain: "estoque-rick-tatuador.firebaseapp.com",
  projectId: "estoque-rick-tatuador",
  storageBucket: "estoque-rick-tatuador.firebasestorage.app",
  messagingSenderId: "446550868475",
  appId: "1:446550868475:web:2a2ba89ccc5a076fcacb5e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data = {};
let history = [];

async function load(){
  const snap = await getDoc(doc(db,"estoque","principal"));
  if(snap.exists()) data = snap.data().data || {};
  const h = await getDoc(doc(db,"estoque","history"));
  history = h.exists() ? h.data().list : [];
  render();
}

async function save(){
  await setDoc(doc(db,"estoque","principal"),{data});
  await setDoc(doc(db,"estoque","history"),{list:history});
}

window.addProduct = async ()=>{
  let cat = newCat.value || catSelect.value;
  if(!cat || !newName.value) return alert("Preencha categoria e produto");
  if(!data[cat]) data[cat]={};
  data[cat][newName.value] = parseInt(newQty.value)||0;
  history.unshift(`‚ûï ${newName.value} (${user})`);
  newCat.value=newName.value=newQty.value="";
  await save(); render();
}

window.changeQty = async (cat, prod, delta)=>{
  data[cat][prod] += delta;
  if(data[cat][prod] < 0) data[cat][prod] = 0;
  history.unshift(`${delta>0?'‚ûï':'‚ûñ'} ${prod} (${user})`);
  await save(); render();
}

window.editCategory = async (oldCat)=>{
  let newName = prompt("Novo nome da categoria:", oldCat);
  if(newName && newName !== oldCat){
    data[newName] = data[oldCat];
    delete data[oldCat];
    history.unshift(`‚úèÔ∏è Categoria "${oldCat}" renomeada para "${newName}" (${user})`);
    await save(); render();
  }
}

window.deleteCategory = async (cat)=>{
  if(confirm(`Tem certeza que deseja excluir a categoria "${cat}" e todos os produtos?`)){
    delete data[cat];
    history.unshift(`üóëÔ∏è Categoria "${cat}" exclu√≠da (${user})`);
    await save(); render();
  }
}

window.editProduct = async (cat, prod)=>{
  let newName = prompt("Novo nome do produto:", prod);
  if(newName && newName !== prod){
    data[cat][newName] = data[cat][prod];
    delete data[cat][prod];
    history.unshift(`‚úèÔ∏è Produto "${prod}" renomeado para "${newName}" (${user})`);
    await save(); render();
  }
}

window.deleteProduct = async (cat, prod)=>{
  if(confirm(`Tem certeza que deseja excluir o produto "${prod}"?`)){
    delete data[cat][prod];
    history.unshift(`üóëÔ∏è Produto "${prod}" exclu√≠do (${user})`);
    await save(); render();
  }
}

window.render = ()=>{
  stock.innerHTML="";
  catSelect.innerHTML="";
  Object.keys(data).forEach(cat=>{
    catSelect.innerHTML+=`<option>${cat}</option>`;
    let box=document.createElement("div");
    box.className="box card";
    box.innerHTML=`<h3>${cat} 
      <button onclick="editCategory('${cat}')">‚úèÔ∏è</button>
      <button onclick="deleteCategory('${cat}')">üóëÔ∏è</button>
    </h3>`;
    Object.keys(data[cat]).forEach(prod=>{
      let qty=data[cat][prod];
      box.innerHTML+=`
      <div class="item">
        <span class="${qty===0?'zero':''}">${prod}: ${qty}</span>
        <span class="controls">
          <button onclick="changeQty('${cat}','${prod}',-1)">‚àí</button>
          <button onclick="changeQty('${cat}','${prod}',1)">+</button>
          <button onclick="editProduct('${cat}','${prod}')">‚úèÔ∏è</button>
          <button onclick="deleteProduct('${cat}','${prod}')">üóëÔ∏è</button>
        </span>
      </div>`;
    });
    document.getElementById('estoquePage').appendChild(box);
  });
  historyDiv.innerHTML = history.slice(0,20).map(h=>`<div>${h}</div>`).join("");
}

function showPage(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  if(page==='estoque') document.getElementById('estoquePage').classList.add('active');
  if(page==='historico') document.getElementById('historicoPage').classList.add('active');
  if(page==='categorias') document.getElementById('categoriasPage').classList.add('active');
}

load();
</script>

<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
