<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESTOQUE DO ESTÃšDIO RICK TATUADOR</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
h1{text-align:center}
.box{background:#fff;padding:10px;margin-bottom:10px;border-radius:8px}
input,select,button{width:100%;padding:8px;margin:4px 0}
button{font-size:16px}
.item{display:flex;justify-content:space-between;align-items:center;margin:4px 0}
.controls button{width:auto;margin-left:4px}
.zero{color:red;font-weight:bold}
</style>
</head>
<body>

<script>
let user = prompt("Digite seu nome:");
</script>

<h1>ESTOQUE DO ESTÃšDIO RICK TATUADOR</h1>

<div class="box">
<input placeholder="ðŸ” Pesquisar produto">
</div>

<div class="box">
<select id="catSelect"></select>
<input id="newCat" placeholder="Ou nova categoria">
<input id="newName" placeholder="Produto">
<input id="newQty" type="number" placeholder="Quantidade">
<button onclick="addProduct()">Adicionar</button>
</div>

<div id="stock"></div>

<!-- CONTROLES DO HISTÃ“RICO -->
<div class="box">
<button onclick="mostrarHistorico('todos')">ðŸ“œ Todos</button>
<button onclick="mostrarHistorico('adicoes')">âž• AdiÃ§Ãµes</button>
<button onclick="mostrarHistorico('remocoes')">âž– RemoÃ§Ãµes</button>
</div>

<div class="box">
<label>Limpar histÃ³rico atÃ© a data:</label>
<input type="date" id="dataLimite">
<button onclick="limparHistoricoPorData()">ðŸ§¹ Limpar HistÃ³rico</button>
</div>

<div class="box">
<h3>ðŸ“œ HistÃ³rico</h3>
<div id="historyDiv"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPF8DpKpIHpYsdTRNCgHgiwCqUcosLX6c",
  authDomain: "estoque-rick-tatuador.firebaseapp.com",
  projectId: "estoque-rick-tatuador",
  storageBucket: "estoque-rick-tatuador.firebasestorage.app",
  messagingSenderId: "446550868475",
  appId: "1:446550868475:web:2a2ba89ccc5a076fcacb5e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data = {};
let history = { adicoes: [], remocoes: [] };
let tipoHistoricoAtual = "todos";

async function load(){
  const snap = await getDoc(doc(db,"estoque","principal"));
  if(snap.exists()) data = snap.data().data || {};

  const h = await getDoc(doc(db,"estoque","history"));
  if(h.exists()) history = h.data();

  render();
}

async function save(){
  await setDoc(doc(db,"estoque","principal"),{data});
  await setDoc(doc(db,"estoque","history"),history);
}

function registrarHistorico(tipo, cat, prod, qtd){
  const r = {
    categoria: cat,
    produto: prod,
    quantidade: qtd,
    usuario: user,
    data: new Date().toISOString()
  };
  tipo === "adicao" ? history.adicoes.unshift(r) : history.remocoes.unshift(r);
}

window.addProduct = async ()=>{
  let cat = newCat.value || catSelect.value;
  if(!cat || !newName.value) return alert("Preencha categoria e produto");
  if(!data[cat]) data[cat] = {};
  data[cat][newName.value] = parseInt(newQty.value)||0;
  registrarHistorico("adicao", cat, newName.value, parseInt(newQty.value)||0);
  newCat.value=newName.value=newQty.value="";
  await save(); render();
}

window.changeQty = async (cat, prod, delta)=>{
  data[cat][prod] += delta;
  if(data[cat][prod] < 0) data[cat][prod] = 0;
  delta > 0
    ? registrarHistorico("adicao", cat, prod, delta)
    : registrarHistorico("remocao", cat, prod, Math.abs(delta));
  await save(); render();
}

window.render = ()=>{
  stock.innerHTML="";
  catSelect.innerHTML="";
  Object.keys(data).forEach(cat=>{
    catSelect.innerHTML+=`<option>${cat}</option>`;
    let box=document.createElement("div");
    box.className="box";
    box.innerHTML=`<h3>${cat}</h3>`;
    Object.keys(data[cat]).forEach(prod=>{
      let qty=data[cat][prod];
      box.innerHTML+=`
      <div class="item">
        <span class="${qty===0?'zero':''}">${prod}: ${qty}</span>
        <span class="controls">
          <button onclick="changeQty('${cat}','${prod}',-1)">âˆ’</button>
          <button onclick="changeQty('${cat}','${prod}',1)">+</button>
        </span>
      </div>`;
    });
    stock.appendChild(box);
  });
  renderHistorico();
}

window.mostrarHistorico = tipo=>{
  tipoHistoricoAtual = tipo;
  renderHistorico();
}

function renderHistorico(){
  let html="";
  if(tipoHistoricoAtual==="todos"||tipoHistoricoAtual==="adicoes"){
    html+="<h4>âž• AdiÃ§Ãµes</h4>";
    html+=history.adicoes.slice(0,20).map(h=>
      `<div>âž• ${h.produto} (${h.quantidade}) - ${h.usuario} - ${new Date(h.data).toLocaleString()}</div>`
    ).join("");
  }
  if(tipoHistoricoAtual==="todos"||tipoHistoricoAtual==="remocoes"){
    html+="<hr><h4>âž– RemoÃ§Ãµes</h4>";
    html+=history.remocoes.slice(0,20).map(h=>
      `<div>âž– ${h.produto} (${h.quantidade}) - ${h.usuario} - ${new Date(h.data).toLocaleString()}</div>`
    ).join("");
  }
  historyDiv.innerHTML=html;
}

window.limparHistoricoPorData = async ()=>{
  const d = document.getElementById("dataLimite").value;
  if(!d) return alert("Selecione uma data");
  const limite = new Date(d);
  history.adicoes = history.adicoes.filter(h=>new Date(h.data)>limite);
  history.remocoes = history.remocoes.filter(h=>new Date(h.data)>limite);
  await save(); renderHistorico();
}

load();
</script>

<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
