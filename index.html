<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESTOQUE DO ESTÃšDIO RICK TATUADOR</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px;transition:0.3s}
.dark{background:#121212;color:white}
h1{text-align:center}
.box{background:#fff;padding:10px;margin-bottom:10px;border-radius:8px}
.dark .box{background:#1e1e1e}
input,select,button{width:100%;padding:8px;margin:4px 0}
button{cursor:pointer;transition:0.2s}
button:active{transform:scale(0.95)}
.item{display:flex;justify-content:space-between;align-items:center}
.controls button{width:auto;margin-left:4px}
.zero{color:red;font-weight:bold}
.low{color:orange;font-weight:bold}
.highlight{background:#ffff99;border-radius:4px}
.footer{text-align:center;margin-top:20px;font-size:14px;color:#666}
.dark .footer{color:#aaa}
.userBox{text-align:center;margin-bottom:10px;font-weight:bold}
.userHistory{margin-bottom:15px;padding:8px;border-radius:6px;background:#f7f7f7}
.dark .userHistory{background:#2a2a2a}
.userHistory h4{margin:0 0 5px 0}
</style>
</head>

<body>

<h1>ESTOQUE DO ESTÃšDIO RICK TATUADOR</h1>

<div class="userBox" id="userBox"></div>
<button onclick="logout()">ðŸšª Sair</button>

<div class="box">
<input id="search" placeholder="ðŸ” Pesquisar produto">
<button onclick="buscarProduto()">Pesquisar</button>
</div>

<div class="box">
<select id="catSelect"></select>
<input id="newCat" placeholder="Ou nova categoria">
<input id="newName" placeholder="Produto">
<input id="newQty" type="number" placeholder="Quantidade">
<button onclick="addProduct()">Adicionar</button>
</div>

<div id="stock"></div>

<div class="box">
<h3>ðŸ“œ HistÃ³rico Geral</h3>
<div id="histAdd"></div>
<button onclick="clearHistory()">Limpar HistÃ³rico do Meu UsuÃ¡rio</button>
</div>

<div class="footer" id="footer"></div>

<button onclick="toggleDark()">ðŸŒ™ Alternar Modo Escuro</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_API_AQUI",
  authDomain: "SEU_AUTH",
  projectId: "SEU_PROJECT",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data = {};
let history = {};
let user = null;
let lastFound = null;

/* LOGIN */
async function login(){
  user = localStorage.getItem("usuarioLogado");

  if(!user){
    const nome = prompt("Digite seu nome:");
    if(!nome) return login();

    const userDoc = await getDoc(doc(db,"usuarios",nome));
    if(!userDoc.exists()){
      if(confirm("UsuÃ¡rio nÃ£o cadastrado. Deseja cadastrar?")){
        await setDoc(doc(db,"usuarios",nome),{
          criadoEm:new Date().toLocaleString()
        });
        alert("UsuÃ¡rio cadastrado!");
      }else{
        return login();
      }
    }
    localStorage.setItem("usuarioLogado",nome);
    user = nome;
  }

  document.getElementById("userBox").innerHTML =
  `UsuÃ¡rio: ${user}`;
}

window.logout = ()=>{
  localStorage.removeItem("usuarioLogado");
  location.reload();
};

/* TEMPO REAL */
onSnapshot(doc(db,"estoque","principal"), snap=>{
  if(snap.exists()){
    data = snap.data().data || {};
    render();
  }
});

onSnapshot(doc(db,"estoque","history"), snap=>{
  if(snap.exists()){
    history = snap.data();
    renderHistory();
  }
});

async function save(){
  await setDoc(doc(db,"estoque","principal"),{data});
  await setDoc(doc(db,"estoque","history"),history);
}

/* AÃ‡Ã•ES */
window.addProduct = async ()=>{
  let cat = newCat.value || catSelect.value;
  if(!cat || !newName.value) return alert("Preencha tudo");
  if(!data[cat]) data[cat]={};

  data[cat][newName.value] = parseInt(newQty.value)||0;

  if(!history[user]) history[user]=[];
  history[user].unshift(`âž• ${newName.value} - ${new Date().toLocaleString()}`);

  newCat.value=newName.value=newQty.value="";
  await save();
};

window.changeQty = async (cat,prod,delta)=>{
  data[cat][prod]+=delta;
  if(data[cat][prod]<0) data[cat][prod]=0;

  if(!history[user]) history[user]=[];
  history[user].unshift(
    `${delta>0?'âž•':'âž–'} ${prod} - ${new Date().toLocaleString()}`
  );

  await save();
};

/* HISTÃ“RICO VISÃVEL PARA TODOS */
function renderHistory(){
  histAdd.innerHTML="";

  Object.keys(history).forEach(u=>{
    let div=document.createElement("div");
    div.className="userHistory";
    div.innerHTML=`<h4>ðŸ‘¤ ${u}</h4>` +
      history[u].map(h=>`<div>${h}</div>`).join("");
    histAdd.appendChild(div);
  });
}

window.clearHistory = async ()=>{
  if(!confirm("Limpar apenas seu histÃ³rico?")) return;
  history[user]=[];
  await save();
};

/* RESTANTE IGUAL */
window.toggleDark = ()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode",document.body.classList.contains("dark"));
};
if(localStorage.getItem("darkMode")==="true"){
  document.body.classList.add("dark");
}

function updateFooter(){
  const now = new Date();
  document.getElementById("footer").innerHTML=`
  VersÃ£o automÃ¡tica<br>
  Ãšltima atualizaÃ§Ã£o: ${now.toLocaleString()}<br><br>
  UsuÃ¡rio ativo: ${user}<br><br>
  Criado por Denis Costa
  `;
}

await login();
updateFooter();
</script>

</body>
</html>
