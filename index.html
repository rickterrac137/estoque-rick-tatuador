<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESTOQUE DO EST√öDIO RICK TATUADOR</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px;transition:0.3s}
.dark{background:#121212;color:#fff}
h1{text-align:center}
.box{background:#fff;padding:10px;margin-bottom:10px;border-radius:8px}
.dark .box{background:#1e1e1e}
input,select,button{width:100%;padding:8px;margin:4px 0}
.item{display:flex;justify-content:space-between;align-items:center}
.controls button{width:auto;margin-left:4px}
.zero{color:red;font-weight:bold}
.low{color:orange;font-weight:bold}
.highlight{background:#ffff99;border-radius:4px}
.footer{margin-top:20px;text-align:center;font-size:14px}
.clear-btn{background:#f44336;color:white;border:none;padding:6px 8px;border-radius:4px;cursor:pointer}
</style>
</head>

<body>

<script>
let currentUser = localStorage.getItem("usuarioLogado");
if(!currentUser){
  let nome = prompt("Digite seu nome para entrar:");
  if(nome){
    localStorage.setItem("usuarioLogado", nome);
    currentUser = nome;
  }else{
    alert("Nome obrigat√≥rio.");
    location.reload();
  }
}
</script>

<h1>ESTOQUE DO EST√öDIO RICK TATUADOR</h1>

<div class="box">
<input id="search" placeholder="üîç Pesquisar produto">
<button onclick="buscarProduto()">Pesquisar</button>
</div>

<div class="box">
<select id="catSelect"></select>
<input id="newCat" placeholder="Ou nova categoria">
<input id="newName" placeholder="Produto">
<input id="newQty" type="number" placeholder="Quantidade">
<button onclick="addProduct()">Adicionar</button>
</div>

<div id="stock"></div>

<div class="box">
<h3>üìú Hist√≥rico por Usu√°rio</h3>
<div id="historyBox"></div>
<button id="clearBtn" class="clear-btn" onclick="clearHistory()">Limpar Hist√≥rico Geral</button>
</div>

<div class="box">
<button onclick="toggleDarkMode()">üåô Modo Escuro</button>
</div>

<div class="footer" id="footer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_AUTH_DOMAIN",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_BUCKET",
  messagingSenderId: "SEU_MSG_ID",
  appId: "SEU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data = {};
let history = [];

onSnapshot(doc(db,"estoque","principal"), snap=>{
  if(snap.exists()) data = snap.data().data || {};
  render();
});

onSnapshot(doc(db,"estoque","history"), snap=>{
  if(snap.exists()) history = snap.data().logs || [];
  renderHistory();
});

async function save(){
  await setDoc(doc(db,"estoque","principal"),{data});
  await setDoc(doc(db,"estoque","history"),{logs:history});
}

window.addProduct = async ()=>{
  let cat = newCat.value || catSelect.value;
  if(!cat || !newName.value) return alert("Preencha tudo");
  if(!data[cat]) data[cat]={};

  data[cat][newName.value] = parseInt(newQty.value)||0;

  history.unshift({
    user: currentUser,
    action: "‚ûï",
    product: newName.value,
    date: new Date().toLocaleString()
  });

  newCat.value=newName.value=newQty.value="";
  await save();
};

window.changeQty = async (cat, prod, delta)=>{
  data[cat][prod]+=delta;
  if(data[cat][prod]<0) data[cat][prod]=0;

  history.unshift({
    user: currentUser,
    action: delta>0?"‚ûï":"‚ûñ",
    product: prod,
    date: new Date().toLocaleString()
  });

  await save();
};

window.editCategory = async (cat)=>{
  let n = prompt("Novo nome da categoria:",cat);
  if(!n||n===cat) return;
  data[n]=data[cat]; delete data[cat];
  await save();
};

window.deleteCategory = async (cat)=>{
  if(!confirm("Excluir categoria inteira?")) return;
  delete data[cat];
  await save();
};

window.editProduct = async (cat,prod)=>{
  let n = prompt("Novo nome do produto:",prod);
  if(!n||n===prod) return;
  data[cat][n]=data[cat][prod]; delete data[cat][prod];
  await save();
};

window.deleteProduct = async (cat,prod)=>{
  if(!confirm("Excluir produto?")) return;
  delete data[cat][prod];
  await save();
};

function render(){
  stock.innerHTML=""; catSelect.innerHTML="";
  Object.keys(data).forEach(cat=>{
    catSelect.innerHTML+=`<option>${cat}</option>`;
    let b=document.createElement("div");
    b.className="box";
    b.innerHTML=`<h3>${cat}
      <button onclick="editCategory('${cat}')">‚úèÔ∏è</button>
      <button onclick="deleteCategory('${cat}')">üóëÔ∏è</button>
    </h3>`;
    Object.keys(data[cat]).forEach(p=>{
      let q=data[cat][p];
      let cls=q===0?"zero":q<5?"low":"";
      b.innerHTML+=`
      <div class="item">
        <span class="${cls}">${p}: ${q}</span>
        <span class="controls">
          <button onclick="changeQty('${cat}','${p}',-1)">‚àí</button>
          <button onclick="changeQty('${cat}','${p}',1)">+</button>
          <button onclick="editProduct('${cat}','${p}')">‚úèÔ∏è</button>
          <button onclick="deleteProduct('${cat}','${p}')">üóëÔ∏è</button>
        </span>
      </div>`;
    });
    stock.appendChild(b);
  });
}

function renderHistory(){
  historyBox.innerHTML="";
  let grouped={};
  history.forEach(log=>{
    if(!grouped[log.user]) grouped[log.user]=[];
    grouped[log.user].push(log);
  });

  Object.keys(grouped).forEach(user=>{
    historyBox.innerHTML+=`<h4>üë§ ${user}</h4>`;
    grouped[user].forEach(log=>{
      historyBox.innerHTML+=`
        <div>${log.action} ${log.product} ‚Äî ${log.date}</div>`;
    });
  });

  if(currentUser!=="Rick"){
    document.getElementById("clearBtn").style.display="none";
  }
}

window.clearHistory = async ()=>{
  if(currentUser!=="Rick") return;
  if(!confirm("Tem certeza que deseja limpar todo o hist√≥rico?")) return;
  history=[];
  await save();
};

window.toggleDarkMode=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode",
    document.body.classList.contains("dark"));
};

if(localStorage.getItem("darkMode")==="true"){
  document.body.classList.add("dark");
}

async function loadVersion(){
  const vDoc=await getDoc(doc(db,"config","version"));
  let version=vDoc.exists()?vDoc.data().version:"Auto";
  footer.innerHTML=`Vers√£o do App: ${version}<br>
  Atualizado em: ${new Date().toLocaleString()}<br>
  Criado por Denis Costa`;
}
loadVersion();
</script>
</body>
</html>
