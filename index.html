ght{background:#ffff99;border-radius:4px}
.footer{margin-top:20px;text-align:center;color:#555;font-size:14px}
.clear-btn{margin-top:4px;background:#f44336;color:white;border:none;padding:6px 8px;border-radius:4px;cursor:pointer}
.clear-btn:hover{opacity:0.8}

.dark{background:#121212;color:#f2f2f2}
.dark .box{background:#1e1e1e}
.dark input,.dark select,.dark button{
background:#2a2a2a;color:white;border:1px solid #444
}

.update-alert{
background:#ff9800;
color:#000;
padding:8px;
border-radius:6px;
margin-bottom:10px;
cursor:pointer;
font-weight:bold;
}
</style>
</head>

<body>

<script>
let user = prompt("Digite seu nome:");
</script>

<h1>ESTOQUE DO EST√öDIO RICK TATUADOR</h1>

<div id="updateBox"></div>

<div class="box">
<input id="search" placeholder="üîç Pesquisar produto">
<button onclick="buscarProduto()">Pesquisar</button>
</div>

<div class="box">
<select id="catSelect"></select>
<input id="newCat" placeholder="Ou nova categoria">
<input id="newName" placeholder="Produto">
<input id="newQty" type="number" placeholder="Quantidade">
<button onclick="addProduct()">Adicionar</button>
</div>

<div id="stock"></div>

<div class="box">
<h3>üìú Hist√≥rico de Adi√ß√µes</h3>
<div id="histAdd"></div>
<button class="clear-btn" onclick="clearHistory('adicoes')">Limpar Hist√≥rico</button>
</div>

<div class="box">
<h3>üìú Hist√≥rico de Remo√ß√µes</h3>
<div id="histRem"></div>
<button class="clear-btn" onclick="clearHistory('remocoes')">Limpar Hist√≥rico</button>
</div>

<div class="footer" id="footer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî• SUAS CREDENCIAIS CORRETAS */
const firebaseConfig = {
  apiKey: "AIzaSyBPF8DpKpIHpYsdTRNCgHgiwCqUcosLX6c",
  authDomain: "estoque-rick-tatuador.firebaseapp.com",
  projectId: "estoque-rick-tatuador",
  storageBucket: "estoque-rick-tatuador.firebasestorage.app",
  messagingSenderId: "446550868475",
  appId: "1:446550868475:web:2a2ba89ccc5a076fcacb5e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data = {};
let history = { adicoes: [], remocoes: [] };
let lastFound = null;

/* üî¥ TEMPO REAL */
onSnapshot(doc(db,"estoque","principal"), snap=>{
  if(snap.exists()){ data = snap.data().data || {}; render(); }
});
onSnapshot(doc(db,"estoque","history"), snap=>{
  if(snap.exists()){ history = snap.data(); renderHistory(); }
});

async function load(){
  const p = await getDoc(doc(db,"estoque","principal"));
  data = p.exists() && p.data().data ? p.data().data : {};
  const h = await getDoc(doc(db,"estoque","history"));
  if(h.exists()) history = h.data();
  render();
}
async function save(){
  await setDoc(doc(db,"estoque","principal"),{data});
  await setDoc(doc(db,"estoque","history"),history);
}

window.addProduct = async ()=>{
  let cat = newCat.value || catSelect.value;
  if(!cat || !newName.value) return alert("Preencha tudo");
  if(!data[cat]) data[cat]={};
  data[cat][newName.value]=parseInt(newQty.value)||0;
  history.adicoes.unshift(`‚ûï ${newName.value} (${user}) - ${new Date().toLocaleString()}`);
  newCat.value=newName.value=newQty.value="";
  await save();
};

window.changeQty = async (cat,prod,delta)=>{
  data[cat][prod]+=delta;
  if(data[cat][prod]<0) data[cat][prod]=0;
  const msg=`${delta>0?'‚ûï':'‚ûñ'} ${prod} (${user}) - ${new Date().toLocaleString()}`;
  delta>0?history.adicoes.unshift(msg):history.remocoes.unshift(msg);
  await save();
};

window.editCategory = async (cat)=>{
  let n=prompt("Novo nome:",cat);
  if(!n||n===cat) return;
  data[n]=data[cat]; delete data[cat];
  await save();
};

window.deleteCategory = async (cat)=>{
  if(!confirm("Excluir categoria?")) return;
  delete data[cat]; await save();
};

window.editProduct = async (cat,prod)=>{
  let n=prompt("Novo nome:",prod);
  if(!n||n===prod) return;
  data[cat][n]=data[cat][prod]; delete data[cat][prod];
  await save();
};

window.deleteProduct = async (cat,prod)=>{
  if(!confirm("Excluir produto?")) return;
  delete data[cat][prod]; await save();
};

window.buscarProduto = ()=>{
  const termo=search.value.toLowerCase();
  if(lastFound) lastFound.classList.remove("highlight");
  const el=[...document.querySelectorAll('[data-prod]')]
  .find(d=>d.dataset.prod.includes(termo));
  if(el){
    el.scrollIntoView({behavior:"smooth",block:"center"});
    el.classList.add("highlight"); lastFound=el;
  }else alert("Produto n√£o encontrado");
};

function render(){
  stock.innerHTML=""; catSelect.innerHTML="";
  Object.keys(data).forEach(cat=>{
    catSelect.innerHTML+=`<option>${cat}</option>`;
    let b=document.createElement("div");
    b.className="box";
    b.innerHTML=`<h3>${cat}
    <button onclick="editCategory('${cat}')">‚úèÔ∏è</button>
    <button onclick="deleteCategory('${cat}')">üóëÔ∏è</button></h3>`;
    Object.keys(data[cat]).forEach(p=>{
      let q=data[cat][p];
      let cls=q===0?"zero":q<5?"low":"";
      b.innerHTML+=`
      <div class="item" data-prod="${p.toLowerCase()}">
      <span class="${cls}">${p}: ${q}</span>
      <span class="controls">
      <button onclick="changeQty('${cat}','${p}',-1)">‚àí</button>
      <button onclick="changeQty('${cat}','${p}',1)">+</button>
      <button onclick="editProduct('${cat}','${p}')">‚úèÔ∏è</button>
      <button onclick="deleteProduct('${cat}','${p}')">üóëÔ∏è</button>
      </span></div>`;
    });
    stock.appendChild(b);
  });
}

function renderHistory(){
  histAdd.innerHTML=history.adicoes.map(h=>`<div>${h}</div>`).join("");
  histRem.innerHTML=history.remocoes.map(h=>`<div>${h}</div>`).join("");
}

window.clearHistory=async(type)=>{
  if(!confirm("Limpar hist√≥rico?")) return;
  history[type]=[]; await save();
};

/* üåô DARK MODE */
function toggleDarkMode(){
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode",document.body.classList.contains("dark"));
}
if(localStorage.getItem("darkMode")==="true"){
  document.body.classList.add("dark");
}

/* üî• VERS√ÉO AUTOM√ÅTICA */
function gerarVersao(){
  const n=new Date();
  return `${n.getFullYear()}.${n.getMonth()+1}.${n.getDate()}.${n.getHours()}.${n.getMinutes()}`;
}

function verificarAtualizacao(){
  const versaoAtual=gerarVersao();
  const versaoSalva=localStorage.getItem("versaoApp");
  if(versaoSalva && versaoSalva!==versaoAtual){
    updateBox.innerHTML=`<div class="update-alert" onclick="location.reload()">Nova vers√£o dispon√≠vel. Clique para atualizar.</div>`;
  }
  localStorage.setItem("versaoApp",versaoAtual);
}

function atualizarRodape(){
  footer.innerHTML=`
  √öltima atualiza√ß√£o: ${new Date().toLocaleString()}<br>
  Vers√£o: ${gerarVersao()}<br>
  Criado por Denis Costa<br>`;
  
  const btn=document.createElement("button");
  btn.innerText="üåô Modo Escuro";
  btn.onclick=toggleDarkMode;
  footer.appendChild(btn);
}

load();
atualizarRodape();
verificarAtualizacao();

</script>

</body>
</html>

