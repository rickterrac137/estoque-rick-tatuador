<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESTOQUE DO EST√öDIO RICK TATUADOR</title>
<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px;transition:0.3s}
h1{text-align:center}
.box{background:#fff;padding:10px;margin-bottom:10px;border-radius:8px}
input,select,button{width:100%;padding:8px;margin:4px 0}
button{cursor:pointer;transition:0.2s}
button:active{transform:scale(0.95)}
.item{display:flex;justify-content:space-between;align-items:center}
.controls button{width:auto;margin-left:4px}
.zero{color:red;font-weight:bold}
.low{color:orange;font-weight:bold}
.highlight{background:#ffff99;border-radius:4px}
.footer{margin-top:20px;text-align:center;color:#555;font-size:14px}
.clear-btn{margin-top:4px;background:#f44336;color:white;border:none;padding:6px 8px;border-radius:4px;cursor:pointer}
.clear-btn:hover{opacity:0.8}
.dark{background:#121212;color:#f2f2f2}
.dark .box{background:#1e1e1e}
.dark input,.dark select,.dark button{background:#2a2a2a;color:white;border:1px solid #444}
.update-alert{background:#ff9800;color:#000;padding:8px;border-radius:6px;margin-bottom:10px;cursor:pointer;font-weight:bold}
</style>
</head>
<body>

<div id="userBox" class="box"></div>
<div id="updateBox"></div>

<h1>ESTOQUE DO EST√öDIO RICK TATUADOR</h1>

<div class="box">
<input id="search" placeholder="üîç Pesquisar produto">
<button id="btnSearch">Pesquisar</button>
</div>

<div class="box">
<select id="catSelect"></select>
<input id="newCat" placeholder="Ou nova categoria">
<input id="newName" placeholder="Produto">
<input id="newQty" type="number" placeholder="Quantidade">
<button id="btnAdd">Adicionar</button>
</div>

<div id="stock"></div>

<div class="box">
<h3>üìú Hist√≥rico de Adi√ß√µes</h3>
<div id="histAdd"></div>
<button id="clearHistBtnAdd" class="clear-btn">Limpar Hist√≥rico</button>
</div>

<div class="box">
<h3>üìú Hist√≥rico de Remo√ß√µes</h3>
<div id="histRem"></div>
<button id="clearHistBtnRem" class="clear-btn">Limpar Hist√≥rico</button>
</div>

<div class="footer" id="footer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPF8DpKpIHpYsdTRNCgHgiwCqUcosLX6c",
  authDomain: "estoque-rick-tatuador.firebaseapp.com",
  projectId: "estoque-rick-tatuador",
  storageBucket: "estoque-rick-tatuador.firebasestorage.app",
  messagingSenderId: "446550868475",
  appId: "1:446550868475:web:2a2ba89ccc5a076fcacb5e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data = {};
let history = { adicoes: [], remocoes: [] };
let lastFound = null;

window.onload = async () => {
  const newCat = document.getElementById("newCat");
  const newName = document.getElementById("newName");
  const newQty = document.getElementById("newQty");
  const catSelect = document.getElementById("catSelect");
  const search = document.getElementById("search");
  const clearHistBtnAdd = document.getElementById("clearHistBtnAdd");
  const clearHistBtnRem = document.getElementById("clearHistBtnRem");
  const btnAdd = document.getElementById("btnAdd");
  const btnSearch = document.getElementById("btnSearch");

  // Login obrigat√≥rio
  let user = localStorage.getItem("usuarioLogado");
  while(!user){
    user = prompt("Digite seu nome de usu√°rio:");
    if(user) localStorage.setItem("usuarioLogado", user);
  }
  document.getElementById("userBox").innerHTML = `Usu√°rio logado: <b>${user}</b>`;

  // Limpar hist√≥rico apenas Rick
  if(user!=="Rick"){
    clearHistBtnAdd.style.display="none";
    clearHistBtnRem.style.display="none";
  }

  // Firestore tempo real
  onSnapshot(doc(db,"estoque","principal"), snap=>{
    if(snap.exists()){ 
      data = snap.data().data || {}; 
      renderStock();
    }
  });
  onSnapshot(doc(db,"estoque","history"), snap=>{
    if(snap.exists()){ 
      history = snap.data() || {adicoes:[],remocoes:[]}; 
      renderHistory();
    }
  });

  async function save(){
    await setDoc(doc(db,"estoque","principal"),{data});
    await setDoc(doc(db,"estoque","history"),history);
  }

  function renderStock(){
    stock.innerHTML=""; catSelect.innerHTML="";
    Object.keys(data).forEach(cat=>{
      catSelect.innerHTML+=`<option>${cat}</option>`;
      let box=document.createElement("div");
      box.className="box";
      box.innerHTML=`<h3>${cat}
        <button class="editCat">‚úèÔ∏è</button>
        <button class="delCat">üóëÔ∏è</button>
      </h3>`;
      Object.keys(data[cat]).forEach(p=>{
        let q=data[cat][p];
        let cls=q===0?"zero":q<5?"low":"";
        const div = document.createElement("div");
        div.className="item";
        div.dataset.prod = p.toLowerCase();
        div.innerHTML = `<span class="${cls}">${p}: ${q}</span>
        <span class="controls">
          <button class="minusBtn">‚àí</button>
          <button class="plusBtn">+</button>
          <button class="editProd">‚úèÔ∏è</button>
          <button class="delProd">üóëÔ∏è</button>
        </span>`;
        box.appendChild(div);

        // Listeners dos bot√µes do produto
        div.querySelector(".minusBtn").addEventListener("click", ()=>changeQty(cat,p,-1));
        div.querySelector(".plusBtn").addEventListener("click", ()=>changeQty(cat,p,1));
        div.querySelector(".editProd").addEventListener("click", ()=>editProduct(cat,p));
        div.querySelector(".delProd").addEventListener("click", ()=>deleteProduct(cat,p));
      });
      stock.appendChild(box);

      // Listeners categoria
      box.querySelector(".editCat").addEventListener("click", ()=>editCategory(cat));
      box.querySelector(".delCat").addEventListener("click", ()=>deleteCategory(cat));
    });
  }

  function renderHistory() {
    // Adi√ß√µes por usu√°rio
    const usersAdd = {};
    history.adicoes.forEach(h => {
      const match = h.match(/\((.*?)\)/); 
      const userH = match ? match[1] : "Desconhecido";
      const prodMatch = h.match(/‚ûï (.*?) \(/);
      const prod = prodMatch ? prodMatch[1] : "";
      let color = "";
      for(const cat in data){
        if(data[cat][prod]!==undefined){
          if(data[cat][prod]===0) color="red";
          else if(data[cat][prod]<5) color="orange";
          break;
        }
      }
      if(!usersAdd[userH]) usersAdd[userH] = [];
      if(color) usersAdd[userH].push(`<span style="color:${color}">${h}</span>`);
      else usersAdd[userH].push(h);
    });

    histAdd.innerHTML = "";
    for (const u in usersAdd) {
      const div = document.createElement("div");
      div.style.borderBottom = "1px solid #ccc";
      div.style.marginBottom = "6px";
      div.innerHTML = `<b>${u}</b><br>${usersAdd[u].join("<br>")}`;
      histAdd.appendChild(div);
    }

    // Remo√ß√µes por usu√°rio
    const usersRem = {};
    history.remocoes.forEach(h => {
      const match = h.match(/\((.*?)\)/); 
      const userH = match ? match[1] : "Desconhecido";
      const prodMatch = h.match(/‚ûñ (.*?) \(/);
      const prod = prodMatch ? prodMatch[1] : "";
      let color = "";
      for(const cat in data){
        if(data[cat][prod]!==undefined){
          if(data[cat][prod]===0) color="red";
          else if(data[cat][prod]<5) color="orange";
          break;
        }
      }
      if(!usersRem[userH]) usersRem[userH] = [];
      if(color) usersRem[userH].push(`<span style="color:${color}">${h}</span>`);
      else usersRem[userH].push(h);
    });

    histRem.innerHTML = "";
    for (const u in usersRem) {
      const div = document.createElement("div");
      div.style.borderBottom = "1px solid #ccc";
      div.style.marginBottom = "6px";
      div.innerHTML = `<b>${u}</b><br>${usersRem[u].join("<br>")}`;
      histRem.appendChild(div);
    }
  }

  async function addProductFunc(){
    let cat = newCat.value || catSelect.value;
    if(!cat || !newName.value) return alert("Preencha tudo");
    if(!data[cat]) data[cat]={};
    data[cat][newName.value] = parseInt(newQty.value)||0;
    history.adicoes.unshift(`‚ûï ${newName.value} (${user}) - ${new Date().toLocaleString()}`);
    newCat.value = newName.value = newQty.value = "";
    await save(); renderStock(); renderHistory();
  }

  async function changeQty(cat,prod,delta){
    data[cat][prod] = (data[cat][prod]||0)+delta;
    if(data[cat][prod]<0) data[cat][prod]=0;
    const msg = `${delta>0?'‚ûï':'‚ûñ'} ${prod} (${user}) - ${new Date().toLocaleString()}`;
    delta>0 ? history.adicoes.unshift(msg) : history.remocoes.unshift(msg);
    await save(); renderStock(); renderHistory();
  }

  async function clearHistoryFunc(tipo){
    if(user!=="Rick") return;
    if(!confirm("Limpar hist√≥rico?")) return;
    if(tipo==="adicoes") history.adicoes=[];
    if(tipo==="remocoes") history.remocoes=[];
    await save(); renderHistory();
  }

  btnAdd.addEventListener("click", addProductFunc);
  btnSearch.addEventListener("click", ()=>{
    const termo = search.value.toLowerCase();
    if(lastFound) lastFound.classList.remove("highlight");
    const el = [...document.querySelectorAll('[data-prod]')].find(d=>d.dataset.prod.includes(termo));
    if(el){ el.scrollIntoView({behavior:"smooth",block:"center"}); el.classList.add("highlight"); lastFound=el; }
    else alert("Produto n√£o encontrado");
  });

  clearHistBtnAdd.addEventListener("click", ()=>clearHistoryFunc("adicoes"));
  clearHistBtnRem.addEventListener("click", ()=>clearHistoryFunc("remocoes"));

  // Edit/Delete Categoria/Produto globais
  window.editCategory = async cat=>{
    let n = prompt("Novo nome da categoria:",cat);
    if(!n||n===cat) return;
    data[n]=data[cat]; delete data[cat]; await save(); renderStock();
  };
  window.deleteCategory = async cat=>{
    if(!confirm("Excluir categoria?")) return;
    delete data[cat]; await save(); renderStock();
  };
  window.editProduct = async (cat,prod)=>{
    let n = prompt("Novo nome do produto:",prod);
    if(!n||n===prod) return;
    data[cat][n]=data[cat][prod]; delete data[cat][prod]; await save(); renderStock();
  };
  window.deleteProduct = async (cat,prod)=>{
    if(!confirm("Excluir produto?")) return;
    delete data[cat][prod]; await save(); renderStock();
  };

  // Dark Mode
  function toggleDarkMode(){
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode",document.body.classList.contains("dark"));
  }
  if(localStorage.getItem("darkMode")==="true") document.body.classList.add("dark");

  // Vers√£o autom√°tica
  function gerarVersao(){ const n=new Date(); return `${n.getFullYear()}.${n.getMonth()+1}.${n.getDate()}.${n.getHours()}.${n.getMinutes()}`; }
  function verificarAtualizacao(){
    const versaoAtual=gerarVersao();
    const versaoSalva=localStorage.getItem("versaoApp");
    if(versaoSalva && versaoSalva!==versaoAtual){
      updateBox.innerHTML=`<div class="update-alert" onclick="location.reload()">Nova vers√£o dispon√≠vel. Clique para atualizar.</div>`;
    }
    localStorage.setItem("versaoApp",versaoAtual);
  }

  function atualizarRodape(){
    footer.innerHTML=`√öltima atualiza√ß√£o: ${new Date().toLocaleString()}<br>
    Vers√£o: ${gerarVersao()}<br>
    Criado por Denis Costa<br>`;
    const btn=document.createElement("button");
    btn.innerText="üåô Modo Escuro";
    btn.onclick=toggleDarkMode;
    footer.appendChild(btn);
  }

  atualizarRodape();
  verificarAtualizacao();
};
</script>
</body>
</html>
