<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESTOQUE DO EST√öDIO RICK TATUADOR</title>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
h1{text-align:center}
.box{background:#fff;padding:10px;margin-bottom:10px;border-radius:8px}
input,select,button{width:100%;padding:8px;margin:4px 0}
.item{display:flex;justify-content:space-between;align-items:center}
.controls button{width:auto;margin-left:4px}
.zero{color:red;font-weight:bold}
.low{color:orange;font-weight:bold}
.highlight{background:#ffff99;border-radius:4px}
.footer{margin-top:20px;text-align:center;color:#555;font-size:14px}
.clear-btn{margin-top:4px;background:#f44336;color:white;border:none;padding:6px 8px;border-radius:4px;cursor:pointer}
.clear-btn:hover{opacity:0.8}

/* üî• ALERTA DE NOVA VERS√ÉO */
.update-banner{
position:fixed;
bottom:0;
left:0;
right:0;
background:#000;
color:#fff;
padding:12px;
text-align:center;
display:none;
z-index:9999;
}
.update-banner button{
background:#4CAF50;
color:white;
border:none;
padding:6px 12px;
margin-left:10px;
border-radius:4px;
cursor:pointer;
}
</style>
</head>
<body>

<script>
let user = prompt("Digite seu nome:");
</script>

<h1>ESTOQUE DO EST√öDIO RICK TATUADOR</h1>

<div class="box">
<input id="search" placeholder="üîç Pesquisar produto">
<button onclick="buscarProduto()">Pesquisar</button>
</div>

<div class="box">
<select id="catSelect"></select>
<input id="newCat" placeholder="Ou nova categoria">
<input id="newName" placeholder="Produto">
<input id="newQty" type="number" placeholder="Quantidade">
<button onclick="addProduct()">Adicionar</button>
</div>

<div id="stock"></div>

<div class="box">
<h3>üìú Hist√≥rico de Adi√ß√µes</h3>
<div id="histAdd"></div>
<button class="clear-btn" onclick="clearHistory('adicoes')">Limpar Hist√≥rico de Adi√ß√µes</button>
</div>

<div class="box">
<h3>üìú Hist√≥rico de Remo√ß√µes</h3>
<div id="histRem"></div>
<button class="clear-btn" onclick="clearHistory('remocoes')">Limpar Hist√≥rico de Remo√ß√µes</button>
</div>

<div class="footer" id="footer"></div>

<div class="update-banner" id="updateBanner">
Nova vers√£o dispon√≠vel üöÄ
<button onclick="forceReload()">Atualizar agora</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, doc, getDoc, setDoc, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_AUTH_DOMAIN",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_BUCKET",
  messagingSenderId: "SEU_ID",
  appId: "SEU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data = {};
let history = { adicoes: [], remocoes: [] };
let lastFound = null;

/* üî¥ VERS√ÉO AUTOM√ÅTICA */
const BUILD_VERSION = Date.now();
document.getElementById("footer").innerHTML = `
Vers√£o do App: Build ${BUILD_VERSION}<br>
Criado por: Denis Costa
`;

/* üî• DETECTOR AUTOM√ÅTICO DE NOVA VERS√ÉO */
async function checkForUpdate(){
  try{
    const response = await fetch(window.location.href + '?t=' + Date.now(), {cache:"no-store"});
    const text = await response.text();
    const serverVersionMatch = text.match(/Date\.now\(\)/);
    if(!serverVersionMatch){
      document.getElementById("updateBanner").style.display="block";
    }
  }catch(e){}
}

setInterval(checkForUpdate, 60000); // verifica a cada 60 segundos

window.forceReload = ()=>{
  window.location.reload(true);
};

/* üî¥ FIREBASE REALTIME */
onSnapshot(doc(db,"estoque","principal"), snap=>{
  if(snap.exists()) {
    data = snap.data().data || {};
    render();
  }
});

onSnapshot(doc(db,"estoque","history"), snap=>{
  if(snap.exists()) {
    history = snap.data();
    renderHistory();
  }
});

async function load(){
  const p = await getDoc(doc(db,"estoque","principal"));
  data = p.exists() && p.data().data ? p.data().data : {};

  const h = await getDoc(doc(db,"estoque","history"));
  if(h.exists()) history = h.data();

  render();
}

async function save(){
  await setDoc(doc(db,"estoque","principal"),{data});
  await setDoc(doc(db,"estoque","history"),history);
}

window.addProduct = async ()=>{
  let cat = newCat.value || catSelect.value;
  if(!cat || !newName.value) return alert("Preencha tudo");
  if(!data[cat]) data[cat]={};
  data[cat][newName.value] = parseInt(newQty.value)||0;
  history.adicoes.unshift(`‚ûï ${newName.value} (${user}) - ${new Date().toLocaleString()}`);
  newCat.value=newName.value=newQty.value="";
  await save();
};

window.changeQty = async (cat, prod, delta)=>{
  data[cat][prod] += delta;
  if(data[cat][prod] < 0) data[cat][prod] = 0;
  const msg = `${delta>0?'‚ûï':'‚ûñ'} ${prod} (${user}) - ${new Date().toLocaleString()}`;
  delta>0 ? history.adicoes.unshift(msg) : history.remocoes.unshift(msg);
  await save();
};

window.clearHistory = async(type)=>{
  if(!confirm("Tem certeza que deseja limpar o hist√≥rico?")) return;
  history[type] = [];
  await save();
};

window.buscarProduto = ()=>{
  const termo = search.value.toLowerCase();
  if(lastFound) lastFound.classList.remove("highlight");
  const el = Array.from(document.querySelectorAll('[data-prod]'))
                  .find(d=>d.dataset.prod.includes(termo));
  if(el){
    el.scrollIntoView({behavior:"smooth", block:"center"});
    el.classList.add("highlight");
    lastFound = el;
  } else {
    alert("Produto n√£o encontrado");
    lastFound = null;
  }
};

function render(){
  stock.innerHTML=""; catSelect.innerHTML="";
  Object.keys(data).forEach(cat=>{
    catSelect.innerHTML+=`<option>${cat}</option>`;
    let b=document.createElement("div");
    b.className="box";
    b.innerHTML=`<h3>${cat}</h3>`;
    Object.keys(data[cat]).forEach(p=>{
      let q=data[cat][p];
      let cls = q===0?"zero":q<5?"low":"";
      b.innerHTML+=`
      <div class="item" data-prod="${p.toLowerCase()}">
        <span class="${cls}">${p}: ${q}</span>
        <span class="controls">
          <button onclick="changeQty('${cat}','${p}',-1)">‚àí</button>
          <button onclick="changeQty('${cat}','${p}',1)">+</button>
        </span>
      </div>`;
    });
    stock.appendChild(b);
  });
}

function renderHistory(){
  histAdd.innerHTML = history.adicoes.map(h=>`<div>${h}</div>`).join("");
  histRem.innerHTML = history.remocoes.map(h=>`<div>${h}</div>`).join("");
}

load();
</script>

</body>
</html>
